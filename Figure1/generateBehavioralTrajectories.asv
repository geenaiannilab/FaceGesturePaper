%% updated July 2023 
%% generates trial-averaged, and individual trial behavioral trajectories from DLC markers

close all; clear all;
set(0,'defaultAxesFontSize',24);
set(0,'defaultAxesFontWeight','bold');

%% data params 
subject = 'Barney';%'Thor';
date = '210704';%'171010';
runTSNE = false;
subsessions2plot = [2:5 7:10] %[6];
bhvs2plot = [1 2 4];
gestureNames = {'threat','lipsmack','chew'};
markers2use =  'all'; excludeTongue = 1; plotDLCFlag = false; 
newBinSize = 0.01;
tmin = 1;
tmax = 1;
centerNormalizeFlag = 0;
centerFlag = 1;
smoothSize = 50; 

minRestFlag = 1;
minRest = abs(tmin); % in sec; minimal rest prior to move onset (trials to include)

%% set up files to load 

workDir = ['/Users/geena/Dropbox/PhD/SUAinfo/' subject '_' date '/Data4Analysis'];
infoDir = ([workDir 'TDTdata/Info']);

%% concatenate subsession files 
% get relevant files 
flist = natsortfiles(dir([workDir '/bhvspikes_sub*.mat']));
flist = fullfile({flist.folder}, {flist.name}); 

% determine which type of subsession to plot
if strcmpi(subsessions2plot,'face expression')
    subs2use = flist(contains(flist, 'face expression'));
elseif strcmpi(subsessions2plot,'visual expression')
    subs2use = flist(contains(flist, 'visual expression'));
elseif strcmpi(subsessions2plot,'chew expression')
    subs2use = flist(contains(flist, 'chew expression'));
elseif strcmpi(subsessions2plot,'chew')
    subs2use = flist(contains(flist, 'chew'));
elseif strcmpi(subsessions2plot,'rest')
    subs2use = flist(contains(flist, 'rest'));
elseif strcmpi(subsessions2plot, 'all')
    subs2use = flist;
else 
    for i = 1:length(subsessions2plot)
       subs2use(i) = flist(contains(flist, ['sub' num2str(subsessions2plot(i)) '_']));
    end
end

for session = 1:length(subs2use)    
    obhvIn = load(subs2use{session});
    obhvIn = obhvIn.obhv;
    obhv(session) = obhvIn;
end
clear obhvIn;

subsessionInds = [];
allBhv.markers = [];
allBhv.trialTypeData= [];
allBhv.s = []; 
nTotalTrials = [];

for ss = 1:length(subs2use)

    sessionID = obhv(ss).Info.blockname;

    % camera variables different across subjects
    if strcmpi(subject, 'Barney') || strcmpi(subject, 'Dexter')
        faceCameraStream = 'FT1dat';
        bhvSR = 70;

    elseif strcmpi(subject, 'Thor')
        faceCameraStream = 'FT2dat';
        bhvSR = 120;
    end
    
    pulseLength = length(obhv(ss).(faceCameraStream).time);
    nFramesExported = size(obhv(ss).(faceCameraStream).Markers,1);
    if nFramesExported > pulseLength
        disp(['Warning -- sessionID ' num2str(obhv(ss).Info.blockname) ' dropped frames'])
        disp(['nFramesExported from DLC = ' num2str(nFramesExported)]);
        disp(['pulse Length = ' num2str(pulseLength)]);
    end

    %%%%%%% extract DLC marker positions & labels from obhv
    %%%%%
    % 
    DLCin = obhv(ss).(faceCameraStream);
    DLCtimeBase = DLCin.time(1:nFramesExported);
    [DLCmarkers, markerLabels] = processDLCMarkers('DLCin', DLCin, 'markers2use', markers2use,'excludeTongue', true,'smoothSize',smoothSize,'plotFlag',plotDLCFlag);
    subsessionInds(ss+1) = size(DLCmarkers,1); % length of each subsession

    %%%% extract trials 
    obhvThis = takeSpacedBhvs(obhv(ss),minRest,minRestFlag); % remove trials w/ <500 ms rest prior move onset
    allTrials = ismember(cell2mat(obhvThis.evScore(:,5)),bhvs2plot);

    % get rid of chew trials inside faceExp sets
    if strcmpi(subject, 'Thor')  && cell2mat(obhvThis.evScore(1,6)) == 3
        bhv2lose = ~(cell2mat(obhvThis.evScore(:,5)) == 4); 
        allTrials = logical(allTrials.*bhv2lose);
    end

    % remove events whose trial duration is outside of framesExported
    fmin = tmin*bhvSR; % convert to frames
    fmax = tmax*bhvSR;

    allOnsets = cell2mat(obhvThis.evScore(:,1));
    
    % only trials that started >1 s after recording, and finished in time
    theseTrials = (allOnsets >= (fmin )) & (allOnsets + fmax <= nFramesExported);
    
    % only trials as above, IN ADDITION, only bhv = 1,2,4
    theseTrials = logical(allTrials .* theseTrials);
    
    theseOnsets = allOnsets(theseTrials); % handscored index, in subsession
    
    if strcmpi(sessionID, 'Thor-171010-154538') 
        disp(['sessionID = ' sessionID '  -- adjusting onsets for video export']);
        theseOnsets = theseOnsets - 2000; 
        idx2take = (theseOnsets-fmin) >= 0;
        theseOnsets = theseOnsets(idx2take);
        theseTrials= theseTrials(idx2take);

    end
    
    trialTypes = cell2mat(obhvThis.evScore(theseTrials,5));
    nTotalTrials(ss,:) = hist(trialTypes,bhvs2plot);

    % extract trialData
    for tt = 1:length(theseOnsets)
        onsetMin = theseOnsets(tt) - fmin;
        onsetMax = theseOnsets(tt) + fmax;
        thisData = DLCmarkers(onsetMin:onsetMax,:); % DLCmarkers is nFrames x (nMarkersx2)

        %%%% downsample the DLC tracking data
        DLCtimeBase = -tmin:(1/bhvSR):tmax;
        [thisData, downsampledTimeAxis] = rebinBhv(thisData, DLCtimeBase, newBinSize);

        thisTrialTypeData = repmat(trialTypes(tt), [size(thisData,1)],1);

        allBhv.markers = [allBhv.markers; thisData];
        allBhv.trialTypeData = [allBhv.trialTypeData; thisTrialTypeData];
        allBhv.s = [allBhv.s ; obhv(ss).Info.blockname];
        
    end
    
   

end

%%% perform decomposition 
%% Input is nTimepoints x nMarkers,
if centerFlag
     [coeff,score,latent, ~, explained] = pca(allBhv.markers); % centering (subtract column/cell means) done automatically by pca()
elseif centerNormalizeFlag
     [coeff,score,latent, ~, explained] = pca(allBhv.markers,'VariableWeights', 'variance'); 
else
    [coeff,score,latent, ~, explained] = pca(allBhv.markers,'Centered','off');
    disp('performing PCA on uncentered, non-normalized data!')
end


%% per expression type, per trial, extract X&Y positions from -tmin/tmax around onset 
%  bhvTraj(bhv).data = nTimepoints x nMarkers x nTrials 
for bhv = 1:length(bhvs2plot)

    data2grab = (allBhv.trialTypeData) == bhvs2plot(bhv);
    trialDur = length(downsampledTimeAxis);
    nTrials = sum(nTotalTrials);

    bhvTraj(bhv).data = reshape(score(data2grab,:),[trialDur, nTrials(bhv),size(DLCmarkers,2)]);
    % nTrials(bhv) is 26 but score(data2grab,:)) is only 25 trials 
    bhvTraj(bhv).avg = squeeze(mean(bhvTraj(bhv).data,2));
    bhvTraj(bhv).sem = squeeze(std(bhvTraj(bhv).data,[],2) ./ sqrt(nTrials(bhv)));

end

%%% do the TSNE calculations

if runTSNE
    nPCs2use = find(cumsum(latent) ./sum(latent) >= 0.95,1,'first');
    tsneResults = tsne(score(:,1:nPCs2use));
    figure;
    h = gscatter(tsneResults(:,1), tsneResults(:,2),allBhv.trialTypeData,'rbg',[],12);
    legend('Threat','Lipsmack','Chew'); legend boxoff
    xlabel('t-SNE 1');
    ylabel('t-SNE 2');
    title('Characterization of Three Facial Expressions');
end

%% per expression type, per trial, extract new projection of markers 
%  bhvTraj(bhv).data = nTimepoints x nMarkers x nTrials 
for bhv = 1:length(bhvs2plot)

    theseTrials = (allBhv.trialTypeData) == bhvs2plot(bhv);
    trialDur = length(downsampledTimeAxis);
    nTrials = sum(nTotalTrials);

    bhvTraj(bhv).data = reshape(score(theseTrials,:),[trialDur, nTrials(bhv),size(DLCmarkers,2)]);
    
    bhvTraj(bhv).avg = squeeze(mean(bhvTraj(bhv).data,2));
    bhvTraj(bhv).sem = squeeze(std(bhvTraj(bhv).data,[],2) ./ sqrt(nTrials(bhv)));

end

% original marker data, separated by bhv 
for bhv = 1:length(bhvs2plot)

    theseTrials = (allBhv.trialTypeData) == bhvs2plot(bhv);
    trialDur = length(downsampledTimeAxis);
    nTrials = sum(nTotalTrials);

    markerData2plot(bhv).data = reshape(allBhv.markers(theseTrials,:),[trialDur, nTrials(bhv),size(DLCmarkers,2)]);
    
    markerData2plot(bhv).avg = squeeze(mean(markerData2plot(bhv).data,2));
    markerData2plot(bhv).sem = squeeze((std(markerData2plot(bhv).data,[],2)) ./ sqrt(nTrials(bhv)));

end

meanPos = mean(allBhv.markers,1);
taxis = downsampledTimeAxis;
PCweights = coeff(:,1:10);
percentVar = explained; 
[customColormap] = continuousColorMap(length(downsampledTimeAxis));

clear DLCin; clear obhv; clear DLCmarkers;

%% save files 
outDir = ['/Users/geena/Dropbox/PhD/SUAinfo/' subject '_' date '/DLC'];
save([outDir '/markerTrajectories_tmp.mat'], ...
    'bhvTraj','PCweights','meanPos', 'coeff','latent','explained','taxis','bhvs2plot','gestureNames','markerData2plot','markerLabels','customColormap');

%%
function [bhvOut,downsampledTimeBaseVector] = rebinBhv(bhvIn, timeBaseOld, newBinsize)
    
downsampledTimeBaseVector = timeBaseOld(1):newBinsize:timeBaseOld(end);
bhvOut = zeros(length(downsampledTimeBaseVector), size(bhvIn,2));

for j = 1:size(bhvIn,2)
    bhvOut(:,j) = interp1(timeBaseOld, bhvIn(:,j), downsampledTimeBaseVector);
end

end

